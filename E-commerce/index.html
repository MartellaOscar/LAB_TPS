<!DOCTYPE html>
<html lang="it">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>E-commerce 5DINF</title>
    <style>
        body {
            font-family: Arial, Helvetica, sans-serif;
            margin: 0;
            padding: 0
        }

        header {
            background: #0b79d0;
            color: white;
            padding: 16px
        }

        main {
            padding: 20px
        }

        .categories {
            display: flex;
            gap: 12px;
            flex-wrap: wrap
        }

        .cat {
            padding: 12px 18px;
            background: #eee;
            border-radius: 8px;
            cursor: pointer
        }

        .list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
            gap: 12px;
            margin-top: 16px
        }

        .card {
            border: 1px solid #ddd;
            padding: 12px;
            border-radius: 8px;
            background: white
        }

        .btn {
            display: inline-block;
            padding: 8px 12px;
            background: #0b79d0;
            color: white;
            border-radius: 6px;
            text-decoration: none;
            cursor: pointer
        }

        .back {
            margin-bottom: 12px;
            color: #0b79d0;
            cursor: pointer;
            display: inline-block
        }
    </style>
</head>

<body>
    <header>
        <h1>L'E-COMMERCE MIGLIORE DELLA 5DINF :)</h1>
    </header>
    <main id="app">
        <p>Caricamento prodotti…</p>
    </main>

    <!-- jsPDF CDN -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <script>
        // === CONFIG: percorsi dei file (modifica se necessario) ===
        const FILES = {
            casa: './casa.xml',
            informatica: './informatica.json',
            giardino: './giardino.csv',
            sport: './sport.txt'
        };

        // === Utility parser CSV (semplice) ===
        function parseCSV(text) {
            const lines = text.trim().split(/\r?\n/).filter(l => l.trim() !== '');
            // assume header in first line
            const header = lines[0].split(',').map(h => h.trim());
            const rows = lines.slice(1);
            return rows.map(r => {
                // split respecting simple commas; non-robust for quoted commas
                const cols = r.split(',');
                const obj = {};
                header.forEach((h, i) => obj[h] = (cols[i] ?? '').trim());
                return obj;
            });
        }

        // === Parser TXT per lo sport (chiave: valore, blocchi ripetuti) ===
        function parseKeyValueBlocks(text) {
            // Normalizza le righe e separa per pattern "nome:" (o doppia newline)
            // Approccio: trova tutti i blocchi che contengono 'nome:' ...
            // Rimuove eventuali "€" e spazi superflui
            const raw = text.replace(/\r/g, '').trim();
            // Separa cercando 'nome:' che indica l'inizio di un blocco
            const parts = raw.split(/\n(?=nome:)/i).map(p => p.trim()).filter(p => p);
            const objs = parts.map(block => {
                const lines = block.split('\n').map(l => l.trim()).filter(l => l);
                const o = {};
                lines.forEach(line => {
                    const [k, ...rest] = line.split(':');
                    if (!k) return;
                    const key = k.trim().toLowerCase();
                    const value = rest.join(':').trim();
                    // pulizie
                    if (key === 'prezzo') {
                        o.price = value.replace('€', '').trim();
                    } else if (key === 'nome') {
                        o.name = value;
                    } else if (key === 'descrizione') {
                        o.description = value;
                    } else {
                        o[key] = value;
                    }
                });
                return o;
            });
            return objs;
        }

        // === Parser XML per casa.xml ===
        function parseCasaXML(xmlText) {
            const parser = new DOMParser();
            const doc = parser.parseFromString(xmlText, "application/xml");
            const prodotti = Array.from(doc.querySelectorAll('prodotto'));
            return prodotti.map(p => ({
                name: p.querySelector('nome')?.textContent ?? '',
                price: p.querySelector('costo')?.textContent ?? '',
                description: p.querySelector('descrizione')?.textContent ?? ''
            }));
        }

        // === Caricamento di tutti i file ===
        async function loadAll() {
            const results = { items: [] };

            // 1) JSON (informatica)
            try {
                const r = await fetch(FILES.informatica);
                const data = await r.json();
                // mappa campi a {name, price, description, categoria}
                data.forEach(p => results.items.push({
                    name: p.nome ?? p.name,
                    price: (p.costo ?? p.price)?.toString(),
                    description: p.descrizione ?? p.description ?? '',
                    categoria: 'Informatica',
                    source: 'informatica.json'
                }));
            } catch (e) {
                console.error('Errore load informatica', e);
            }

            // 2) XML (casa)
            try {
                const r = await fetch(FILES.casa);
                const txt = await r.text();
                const parsed = parseCasaXML(txt);
                parsed.forEach(p => results.items.push({
                    name: p.name,
                    price: p.price,
                    description: p.description,
                    categoria: 'Casa',
                    source: 'casa.xml'
                }));
            } catch (e) {
                console.error('Errore load casa', e);
            }

            // 3) CSV (giardino)
            try {
                const r = await fetch(FILES.giardino);
                const txt = await r.text();
                // ATTENZIONE: il file deve avere header "Nome Prodotto,Prezzo,Descrizione"
                const parsed = parseCSV(txt);
                parsed.forEach(p => results.items.push({
                    name: p['Nome Prodotto'] ?? p['Nome Prodotto'.trim()] ?? p['Nome'] ?? p['name'] ?? '',
                    price: p['Prezzo'] ?? p['Prezzo'.trim()] ?? p['Price'] ?? '',
                    description: p['Descrizione'] ?? p['Descrizione'.trim()] ?? p['Description'] ?? '',
                    categoria: 'Giardino',
                    source: 'giardino.csv'
                }));
            } catch (e) {
                console.error('Errore load giardino', e);
            }

            // 4) TXT (sport)
            try {
                const r = await fetch(FILES.sport);
                const txt = await r.text();
                const parsed = parseKeyValueBlocks(txt);
                parsed.forEach(p => results.items.push({
                    name: p.name ?? p.nome ?? '',
                    price: p.price ?? p.prezzo ?? '',
                    description: p.description ?? p.descrizione ?? '',
                    categoria: 'Sport',
                    source: 'sport.txt'
                }));
            } catch (e) {
                console.error('Errore load sport', e);
            }

            return results.items;
        }

        // === Render UI ===
        const app = document.getElementById('app');

        function groupByCategory(items) {
            const map = {};
            items.forEach(i => {
                const c = i.categoria || 'Uncategorized';
                if (!map[c]) map[c] = [];
                map[c].push(i);
            });
            return map;
        }

        function renderCatalog(items) {
            app.innerHTML = '';
            const h = document.createElement('div');
            h.innerHTML = '<h2>Catalogo</h2><p>Seleziona una macrocategoria:</p>';
            app.appendChild(h);

            const categories = groupByCategory(items);
            const container = document.createElement('div');
            container.className = 'categories';
            Object.keys(categories).forEach(cat => {
                const el = document.createElement('div');
                el.className = 'cat';
                el.textContent = `${cat} (${categories[cat].length})`;
                el.onclick = () => renderCategory(cat, categories[cat], items);
                container.appendChild(el);
            });
            app.appendChild(container);
        }

        function renderCategory(cat, itemsInCat, allItems) {
            app.innerHTML = `<a class="back" id="back">&larr; Torna al catalogo</a><h2>${cat}</h2>`;
            document.getElementById('back').onclick = () => renderCatalog(allItems);

            const list = document.createElement('div');
            list.className = 'list';
            itemsInCat.forEach((p, idx) => {
                const card = document.createElement('div');
                card.className = 'card';
                card.innerHTML = `<h3>${p.name}</h3>
        <p><strong>Prezzo:</strong> €${Number(p.price).toFixed(2)}</p>
        <p>${(p.description || '').slice(0, 100)}${(p.description || '').length > 100 ? '...' : ''}</p>
        <a class="btn" data-idx="${idx}">Vedi</a>`;
                card.querySelector('a').onclick = () => renderProduct(p, allItems);
                list.appendChild(card);
            });
            app.appendChild(list);
        }

        function renderProduct(p, allItems) {
            app.innerHTML = `<a class="back" id="back">&larr; Torna</a>
      <h2>${p.name}</h2>
      <p><strong>Categoria:</strong> ${p.categoria}</p>
      <p><strong>Prezzo:</strong> €${Number(p.price).toFixed(2)}</p>
      <p>${p.description}</p>
      <div style="margin-top:12px">
        <button id="buyBtn" class="btn">Compra</button>
      </div>`;
            document.getElementById('back').onclick = () => {
                // torna alla lista categoria: ricostruisci dalla categoria
                const grouped = groupByCategory(allItems);
                renderCategory(p.categoria, grouped[p.categoria], allItems);
            };
            document.getElementById('buyBtn').onclick = () => buyProduct(p);
        }

        // === Compra e genera PDF ===
        async function buyProduct(p) {
            // semplice form per inserire nome cliente e quantità
            const name = prompt('Inserisci il tuo nome per lo scontrino:', 'Cliente');
            if (name === null) return;
            let qty = prompt('Quantità:', '1');
            if (qty === null) return;
            qty = Number(qty) || 1;
            const subtotal = (Number(p.price) || 0) * qty;
            const iva = +(subtotal * 0.22).toFixed(2);
            const total = +(subtotal + iva).toFixed(2);

            // genera PDF con jsPDF
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();

            const now = new Date();
            doc.setFontSize(14);
            doc.text("Scontrino - E-COMMERCE 5DINF", 14, 18);
            doc.setFontSize(10);
            doc.text(`Data: ${now.toLocaleString()}`, 14, 26);
            doc.text(`Cliente: ${name}`, 14, 32);
            doc.text(`Prodotto: ${p.name}`, 14, 40);
            doc.text(`Categoria: ${p.categoria}`, 14, 46);
            doc.text(`Prezzo unitario: €${Number(p.price).toFixed(2)}`, 14, 52);
            doc.text(`Quantità: ${qty}`, 14, 58);
            doc.text(`Subtotale: €${subtotal.toFixed(2)}`, 14, 66);
            doc.text(`IVA (22%): €${iva.toFixed(2)}`, 14, 74);
            doc.setFontSize(12);
            doc.text(`Totale: €${total.toFixed(2)}`, 14, 86);

            // opzionale: ID ordine casuale
            const orderId = 'ORD-' + Math.random().toString(36).slice(2, 9).toUpperCase();
            doc.setFontSize(9);
            doc.text(`ID ordine: ${orderId}`, 14, 96);

            doc.save(`scontrino_${orderId}.pdf`);
            alert('Acquisto registrato. Scontrino scaricato.');
        }

        // === Avvio ===
        (async function init() {
            try {
                const items = await loadAll();
                if (!items || items.length === 0) {
                    app.innerHTML = '<p>Non sono presenti prodotti. Controlla i file e il server (CORS/HTTP).</p>';
                    return;
                }
                renderCatalog(items);
            } catch (e) {
                console.error(e);
                app.innerHTML = '<p>Errore durante il caricamento dei prodotti. Controlla la console.</p>';
            }
        })();

    </script>
</body>

</html>